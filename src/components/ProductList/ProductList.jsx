import React, { useState, useEffect } from 'react';
import './ProductList.css';
import ProductCard from '../ProductCard/ProductCard';
import OrderModal from '../OrderModal/OrderModal';
import { useTelegram } from '../hooks/useTelegram';
import { motion } from 'framer-motion';
import Cart from '../Cart/Cart';
import OrderHistory from '../OrderHistory/OrderHistory';

const ProductList = () => {
    const [products, setProducts] = useState({
        snacks: [],
        mainMenu: [],
        drinks: [],
        sauces: []
    });
    const [cart, setCart] = useState([]);
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [activeCategory, setActiveCategory] = useState('all');
    const { tg, user } = useTelegram();
    const [isCartOpen, setIsCartOpen] = useState(false);
    const [searchQuery, setSearchQuery] = useState('');
    const [sortType, setSortType] = useState('default');
    const [isLoading, setIsLoading] = useState(true);
    const [activeTags, setActiveTags] = useState([]);

    const containerVariants = {
        hidden: { opacity: 0 },
        visible: {
            opacity: 1,
            transition: {
                staggerChildren: 0.1
            }
        }
    };

    const itemVariants = {
        hidden: { y: 20, opacity: 0 },
        visible: {
            y: 0,
            opacity: 1
        }
    };

    const getCategoryTitle = (category) => {
        const titles = {
            snacks: 'üçü –°–Ω–µ–∫–∏',
            mainMenu: 'üç¥ –û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é',
            drinks: 'ü•§ –ù–∞–ø–∏—Ç–∫–∏',
            sauces: 'ü•´ –°–æ—É—Å—ã'
        };
        return titles[category] || category;
    };

    useEffect(() => {
        fetchProducts();
    }, []);

    const fetchProducts = async () => {
        setIsLoading(true);
        try {
            const response = await fetch('http://localhost:8000/api/products');
            const data = await response.json();
            console.log('Received products:', data);
            setProducts(data);
        } catch (error) {
            console.error('Error fetching products:', error);
        } finally {
            setIsLoading(false);
        }
    };

    const handleAddToCart = (product) => {
        setCart(prev => [...prev, product]);
        updateMainButton();
    };

    const updateMainButton = () => {
        const totalPrice = cart.reduce((sum, item) => sum + item.finalPrice, 0);
        if (cart.length === 0) {
            tg.MainButton.hide();
        } else {
            tg.MainButton.show();
            tg.MainButton.setParams({
                text: `–ó–∞–∫–∞–∑–∞—Ç—å ‚Ä¢ ${totalPrice}‚ÇΩ`
            });
            tg.MainButton.onClick(() => setIsModalOpen(true));
        }
    };

    const handleOrderSubmit = async (orderData) => {
        const totalPrice = cart.reduce((sum, item) => sum + item.finalPrice, 0);
        
        console.log('Submitting order with data:', {
            products: cart,
            totalPrice,
            ...orderData,
            userId: user?.id
        });

        try {
            const response = await fetch('http://localhost:8000/web-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    products: cart,
                    totalPrice,
                    ...orderData,
                    userId: user?.id
                }),
            });

            const result = await response.json();
            console.log('Order submission result:', result);

            if (response.ok) {
                setIsModalOpen(false);
                setCart([]);
                tg.MainButton.hide();
                
                const message = orderData.deliveryType === 'pickup' 
                    ? '–ú–æ–∂–µ—Ç–µ –∑–∞–±–∏—Ä–∞—Ç—å –∑–∞–∫–∞–∑ —á–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç'
                    : '–î–æ—Å—Ç–∞–≤—â–∏–∫ –±—É–¥–µ—Ç –≤ —Ç–µ—á–µ–Ω–∏–∏ —á–∞—Å–∞';
                    
                tg.showPopup({
                    title: '–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç',
                    message: message,
                    buttons: [{type: 'ok'}]
                });
            }
        } catch (error) {
            console.error('Error submitting order:', error);
            tg.showPopup({
                title: '–û—à–∏–±–∫–∞',
                message: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞',
                buttons: [{type: 'ok'}]
            });
        }
    };

    const handleRemoveFromCart = (index) => {
        setCart(prev => prev.filter((_, i) => i !== index));
        updateMainButton();
    };

    const handleUpdateQuantity = (index, newQuantity) => {
        if (newQuantity < 1) return;
        setCart(prev => prev.map((item, i) => 
            i === index ? { ...item, quantity: newQuantity } : item
        ));
        updateMainButton();
    };

    const toggleTag = (tag) => {
        if (activeTags.includes(tag)) {
            setActiveTags(prev => prev.filter(t => t !== tag));
        } else {
            setActiveTags(prev => [...prev, tag]);
        }
    };

    const getTimeBasedProducts = () => {
        const hour = new Date().getHours();
        if (hour >= 6 && hour < 11) {
            return <div className="time-suggestion">üåÖ –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –∑–∞–≤—Ç—Ä–∞–∫–∞</div>;
        } else if (hour >= 11 && hour < 16) {
            return <div className="time-suggestion">üåû –í—Ä–µ–º—è –æ–±–µ–¥–∞</div>;
        } else if (hour >= 16 && hour < 22) {
            return <div className="time-suggestion">üåÜ –û—Ç–ª–∏—á–Ω—ã–π —É–∂–∏–Ω</div>;
        }
        return <div className="time-suggestion">üåô –ù–æ—á–Ω–æ–π –ø–µ—Ä–µ–∫—É—Å</div>;
    };

    const getRecommendations = (currentProduct) => {
        return products.filter(p => 
            p.category === currentProduct.category && 
            p.id !== currentProduct.id
        ).slice(0, 3);
    };

    const handleReorder = (products) => {
        products.forEach(product => {
            handleAddToCart(product);
        });
    };

    return (
        <div className="product-list-container">
            <header className="product-list-header">
                <div className="user-info">
                    <img 
                        src={user?.photo_url || '/default-avatar.png'} 
                        alt="User" 
                        className="user-avatar"
                    />
                    <span className="username">{user?.username || '–ì–æ—Å—Ç—å'}</span>
                </div>
                <div className="cart-info" onClick={() => setIsCartOpen(true)}>
                    {cart.length > 0 && (
                        <span className="cart-count">{cart.length}</span>
                    )}
                    <span className="cart-icon">üõí</span>
                </div>
            </header>

            <div className="search-bar">
                <input
                    type="text"
                    placeholder="–ü–æ–∏—Å–∫ –±–ª—é–¥..."
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                />
            </div>

            <div className="quick-filters">
                <div 
                    className={`filter-tag ${activeTags.includes('popular') ? 'active' : ''}`}
                    onClick={() => toggleTag('popular')}
                >
                    üî• –ü–æ–ø—É–ª—è—Ä–Ω–æ–µ
                </div>
                <div 
                    className={`filter-tag ${activeTags.includes('spicy') ? 'active' : ''}`}
                    onClick={() => toggleTag('spicy')}
                >
                    üå∂Ô∏è –û—Å—Ç—Ä–æ–µ
                </div>
                <div 
                    className={`filter-tag ${activeTags.includes('new') ? 'active' : ''}`}
                    onClick={() => toggleTag('new')}
                >
                    üÜï –ù–æ–≤–∏–Ω–∫–∏
                </div>
            </div>

            <div className="sort-controls">
                <select value={sortType} onChange={(e) => setSortType(e.target.value)}>
                    <option value="default">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
                    <option value="priceAsc">–°–Ω–∞—á–∞–ª–∞ –¥–µ—à–µ–≤–ª–µ</option>
                    <option value="priceDesc">–°–Ω–∞—á–∞–ª–∞ –¥–æ—Ä–æ–∂–µ</option>
                    <option value="nameAsc">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é –ê-–Ø</option>
                </select>
            </div>

            <nav className="category-nav">
                <button 
                    className={`category-btn ${activeCategory === 'all' ? 'active' : ''}`}
                    onClick={() => setActiveCategory('all')}
                >
                    –í—Å–µ
                </button>
                <button 
                    className={`category-btn ${activeCategory === 'snacks' ? 'active' : ''}`}
                    onClick={() => setActiveCategory('snacks')}
                >
                    üçü –°–Ω–µ–∫–∏
                </button>
                <button 
                    className={`category-btn ${activeCategory === 'mainMenu' ? 'active' : ''}`}
                    onClick={() => setActiveCategory('mainMenu')}
                >
                    üç¥ –û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é
                </button>
                <button 
                    className={`category-btn ${activeCategory === 'drinks' ? 'active' : ''}`}
                    onClick={() => setActiveCategory('drinks')}
                >
                    üçπ –ù–∞–ø–∏—Ç–∫–∏
                </button>
                <button 
                    className={`category-btn ${activeCategory === 'sauces' ? 'active' : ''}`}
                    onClick={() => setActiveCategory('sauces')}
                >
                    üç¥ –°–æ—É—Å—ã
                </button>
            </nav>

            <motion.div 
                className="products-container"
                variants={containerVariants}
                initial="hidden"
                animate="visible"
            >
                {isLoading ? (
                    <div className="loading-skeleton">
                        {[1,2,3,4].map(i => (
                            <div key={i} className="skeleton-card" />
                        ))}
                    </div>
                ) : (
                    Object.entries(products).map(([category, items]) => {
                        const filteredItems = items.filter(item => 
                            item.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                            item.description.toLowerCase().includes(searchQuery.toLowerCase())
                        );
                        
                        return (activeCategory === 'all' || activeCategory === category) && (
                            <motion.section 
                                key={category}
                                variants={itemVariants}
                            >
                                <h2>{getCategoryTitle(category)}</h2>
                                <div className="products-grid">
                                    {filteredItems.map(product => (
                                        <ProductCard 
                                            key={product.id}
                                            product={product}
                                            onAddToCart={handleAddToCart}
                                        />
                                    ))}
                                </div>
                            </motion.section>
                        );
                    })
                )}
            </motion.div>

            <OrderModal
                isOpen={isModalOpen}
                onClose={() => setIsModalOpen(false)}
                onSubmit={handleOrderSubmit}
                totalPrice={cart.reduce((sum, item) => sum + item.finalPrice, 0)}
                cart={cart}
                user={user}
            />

            <Cart 
                isOpen={isCartOpen}
                onClose={() => setIsCartOpen(false)}
                items={cart}
                onRemoveItem={handleRemoveFromCart}
                onUpdateQuantity={handleUpdateQuantity}
            />

            <OrderHistory onReorder={handleReorder} />
        </div>
    );
};

export default ProductList;